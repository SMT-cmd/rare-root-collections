<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RARE ROOT | Prestige</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
/* -------------------------------------------------------
   THEME: PRESTIGE STREETWEAR (Wine, Gold, Dark)
   ------------------------------------------------------- */
:root {
    --bg-dark: #1a0f0d;      /* Very Dark Wine/Black */
    --bg-wine: #2c1b18;      /* Deep Earthy Wine */
    --bg-card: #251614;      /* Slightly lighter for cards */
    --text-gold: #e0c097;    /* Muted Gold */
    --text-cream: #f4f1ea;   /* Soft White */
    --accent-red: #8a2be2;   /* Royal Purple/Red Accent */
    --glass: rgba(37, 22, 20, 0.85);
    --font-head: 'Cinzel', serif;
    --font-body: 'Inter', sans-serif;
}

html {
    scroll-behavior: smooth;
}

body {
    margin: 0;
    padding: 0;
    font-family: var(--font-body);
    background-color: var(--bg-dark);
    color: var(--text-cream);
    overflow-x: hidden;
    line-height: 1.6;
}

/* -------------------------------------------------------
   ANIMATIONS
   ------------------------------------------------------- */
.reveal-on-scroll {
    opacity: 0;
    transform: translateY(30px);
    transition: all 0.8s cubic-bezier(0.5, 0, 0, 1);
}

.reveal-on-scroll.visible {
    opacity: 1;
    transform: translateY(0);
}

@keyframes float {
    0% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
    100% { transform: translateY(0px); }
}

/* -------------------------------------------------------
   HEADER & MENU
   ------------------------------------------------------- */
nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 40px;
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(26, 15, 13, 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(224, 192, 151, 0.1);
    transition: padding 0.3s;
}

.menu-btn {
    background: none;
    border: none;
    color: var(--text-gold);
    font-size: 1.8rem;
    cursor: pointer;
    transition: transform 0.3s;
}
.menu-btn:hover { transform: scale(1.1); }

.logo {
    display: block;
    text-align: center;
}

.nav-logo-img {
    height: 120px; /* Bold size */
    width: auto;
    display: block;
    transition: transform 0.3s ease;
    filter: drop-shadow(0 0 10px rgba(0,0,0,0.5));
}

.nav-logo-img:hover {
    transform: scale(1.05);
}

.nav-actions {
    display: flex;
    align-items: center;
    gap: 25px;
}

.cart-icon {
    position: relative;
    cursor: pointer;
    font-family: var(--font-head);
    color: var(--text-gold);
    font-size: 0.9rem;
    letter-spacing: 1px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.cart-count {
    background: var(--text-gold);
    color: var(--bg-dark);
    font-size: 0.75rem;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: bold;
}

/* -------------------------------------------------------
   HERO SECTION
   ------------------------------------------------------- */
.hero {
    position: relative;
    text-align: center;
    padding: 160px 20px 100px;
    background: radial-gradient(circle at center, rgba(62, 39, 35, 0.4) 0%, var(--bg-dark) 70%);
    overflow: hidden;
}

.hero::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23e0c097' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    opacity: 1;
    z-index: -1;
}

.hero-title {
    font-family: var(--font-head);
    font-size: 5rem;
    color: var(--text-gold);
    margin: 0 0 20px;
    line-height: 1;
    text-transform: uppercase;
    letter-spacing: -2px;
    text-shadow: 0 10px 30px rgba(0,0,0,0.5);
    opacity: 0; /* Animated by JS */
    animation: fadeInUp 1s forwards 0.2s;
}

.hero-subtitle {
    font-size: 1.2rem;
    letter-spacing: 6px;
    text-transform: uppercase;
    color: var(--text-cream);
    opacity: 0;
    font-weight: 300;
    margin-bottom: 50px;
    animation: fadeInUp 1s forwards 0.5s;
}

.btn-hero {
    background: var(--text-gold);
    border: none;
    color: var(--bg-dark);
    padding: 18px 50px;
    font-family: var(--font-body);
    font-size: 0.9rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 2px;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
    opacity: 0;
    animation: fadeInUp 1s forwards 0.8s;
}

.btn-hero:hover {
    background: #fff;
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(224, 192, 151, 0.2);
}

@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(40px); }
    to { opacity: 1; transform: translateY(0); }
}

/* -------------------------------------------------------
   BRAND IDENTITY
   ------------------------------------------------------- */
.brand-identity {
    padding: 80px 20px;
    text-align: center;
    max-width: 900px;
    margin: 0 auto;
    position: relative;
}

.brand-text {
    font-size: 1.25rem;
    line-height: 1.8;
    color: var(--text-cream);
    opacity: 0.9;
    font-weight: 300;
}

.brand-text strong {
    color: var(--text-gold);
    font-weight: 600;
}

/* -------------------------------------------------------
   LAYOUT & GRID
   ------------------------------------------------------- */
.container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 0 40px;
}

.collection-header {
    margin: 120px 0 60px;
    text-align: center;
    position: relative;
}

.collection-header::after {
    content: '';
    display: block;
    width: 60px;
    height: 2px;
    background: var(--text-gold);
    margin: 20px auto 0;
    opacity: 0.5;
}

.category-title {
    font-family: var(--font-head);
    font-size: 3rem;
    color: var(--text-gold);
    margin: 0;
    letter-spacing: 2px;
}

.category-subtitle {
    font-family: var(--font-body);
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 3px;
    opacity: 0.6;
    margin-top: 10px;
}

.grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 40px;
    margin-bottom: 100px;
}

/* -------------------------------------------------------
   PRODUCT CARDS (MODERN)
   ------------------------------------------------------- */
.product-card {
    background: var(--bg-card);
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.4s ease;
    position: relative;
    border: 1px solid rgba(255,255,255,0.03);
}

.product-card:hover {
    transform: translateY(-10px);
    box-shadow: 0 20px 40px rgba(0,0,0,0.4);
    border-color: rgba(224, 192, 151, 0.2);
}

.product-image-container {
    width: 100%;
    height: 420px;
    overflow: hidden;
    position: relative;
    background: #111;
}

.product-image-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.8s cubic-bezier(0.25, 1, 0.5, 1);
    opacity: 0.9;
}

.product-card:hover .product-image-container img {
    transform: scale(1.1);
    opacity: 1;
}

.discount-badge {
    position: absolute;
    top: 15px;
    left: 15px;
    background-color: var(--text-gold);
    color: var(--bg-dark);
    padding: 4px 10px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    z-index: 2;
}

.add-to-cart-btn {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    width: 80%;
    padding: 12px;
    background: rgba(255, 255, 255, 0.95);
    color: #000;
    border: none;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.8rem;
    letter-spacing: 1px;
    cursor: pointer;
    opacity: 0;
    transition: all 0.4s;
    border-radius: 4px;
}

.product-card:hover .add-to-cart-btn {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
}

.product-info {
    padding: 25px;
    text-align: left;
}

.product-info h3 {
    font-family: var(--font-body);
    font-size: 1rem;
    font-weight: 600;
    margin: 0 0 8px;
    color: var(--text-cream);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.product-info .price {
    font-family: var(--font-body);
    font-weight: 400;
    color: var(--text-gold);
    font-size: 1.1rem;
}

.original-price {
    text-decoration: line-through;
    color: rgba(255,255,255,0.3);
    font-size: 0.9em;
    margin-right: 10px;
}

/* -------------------------------------------------------
   NEWSLETTER
   ------------------------------------------------------- */
.newsletter-section {
    background: linear-gradient(to bottom, var(--bg-dark), #110a09);
    padding: 120px 20px;
    text-align: center;
    border-top: 1px solid rgba(224, 192, 151, 0.05);
}

.newsletter-content h3 {
    font-family: var(--font-head);
    font-size: 2.5rem;
    color: var(--text-gold);
    margin-bottom: 15px;
}

.newsletter-content p {
    color: rgba(244, 241, 234, 0.6);
    margin-bottom: 40px;
}

.newsletter-form {
    display: flex;
    justify-content: center;
    gap: 0;
    max-width: 500px;
    margin: 0 auto;
    position: relative;
}

.newsletter-form input {
    padding: 18px 25px;
    width: 100%;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.1);
    color: var(--text-cream);
    font-family: var(--font-body);
    font-size: 1rem;
    border-radius: 4px 0 0 4px;
    transition: border-color 0.3s;
}

.newsletter-form input:focus {
    outline: none;
    border-color: var(--text-gold);
}

.newsletter-form button {
    padding: 18px 30px;
    background: var(--text-gold);
    border: none;
    color: var(--bg-dark);
    font-weight: 700;
    text-transform: uppercase;
    cursor: pointer;
    border-radius: 0 4px 4px 0;
    transition: background 0.3s;
}

.newsletter-form button:hover {
    background: #fff;
}

/* -------------------------------------------------------
   FOOTER
   ------------------------------------------------------- */
footer {
    background: #110a09;
    padding: 100px 40px 30px;
    border-top: 1px solid rgba(224, 192, 151, 0.1);
}

.footer-content {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr;
    gap: 60px;
    max-width: 1600px;
    margin: 0 auto;
}

.footer-logo {
    height: 80px; /* Bigger footer logo */
    margin-bottom: 20px;
    opacity: 0.9;
}

.footer-col h4 {
    font-family: var(--font-head);
    color: var(--text-gold);
    margin-bottom: 25px;
    font-size: 1.1rem;
}

.footer-col a {
    display: block;
    color: rgba(244, 241, 234, 0.6);
    text-decoration: none;
    margin-bottom: 15px;
    font-size: 0.9rem;
    transition: color 0.3s, transform 0.3s;
}

.footer-col a:hover {
    color: var(--text-gold);
    transform: translateX(5px);
}

.footer-bottom {
    text-align: center;
    margin-top: 80px;
    padding-top: 30px;
    border-top: 1px solid rgba(255,255,255,0.03);
    font-size: 0.8rem;
    color: rgba(255,255,255,0.3);
}

/* -------------------------------------------------------
   DRAWER & MODAL UI UPDATES
   ------------------------------------------------------- */
.menu-drawer, .cart-drawer {
    background: #1a0f0d; /* Match bg-dark */
    border-color: rgba(224, 192, 151, 0.1);
}
.menu-title, .cart-title { font-family: var(--font-head); }

.search-box input {
    border-color: rgba(224, 192, 151, 0.2);
    font-family: var(--font-body);
}

/* Toast */
.toast {
    background-color: var(--text-gold);
    color: var(--bg-dark);
    font-family: var(--font-body);
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

/* Responsive */
@media (max-width: 900px) {
    .hero-title { font-size: 3.5rem; }
    .grid { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
    .footer-content { grid-template-columns: 1fr; text-align: center; gap: 40px; }
    .nav-logo-img { height: 90px; }
}

@media (max-width: 600px) {
    .hero { padding: 120px 20px; }
    .hero-title { font-size: 2.5rem; }
    .collection-header { margin: 80px 0 40px; }
    .nav-actions { gap: 15px; }
    .cart-drawer { width: 100%; }
}
    </style>
    <!-- Favicon -->
    <link rel="icon" href="https://files.fm/thumb.php?i=y628qspy4s" type="image/jpeg">
    
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <!-- Removed Netlify Identity Script -->
</head>
<body>

    <nav>
        <button class="menu-btn" onclick="toggleMenu()">☰</button>
        <a href="#" class="logo">
            <img src="https://files.fm/thumb.php?i=4wunrd26s5" alt="RARE ROOT" class="nav-logo-img">
        </a>
        <div class="nav-actions">
            <div class="search-box">
                <input type="text" id="search-input" placeholder="Search..." onkeyup="handleSearch(this.value)">
            </div>
            <div class="cart-icon" onclick="toggleCart()">
                CART <span id="cart-count" class="cart-count">0</span>
            </div>
        </div>
    </nav>

    <header class="hero">
        <h1 class="hero-title">RARE ROOT</h1>
        <p class="hero-subtitle">Prestige in Every Thread</p>
        <button class="btn-hero" onclick="document.getElementById('exchange-grid').scrollIntoView({behavior: 'smooth'})">Explore the Collection</button>
    </header>

    <!-- Brand Identity Section -->
    <section class="brand-identity" style="padding: 60px 20px; text-align: center; max-width: 800px; margin: 0 auto;">
        <p style="font-size: 1.1rem; line-height: 1.8; color: var(--text-cream); opacity: 0.9;">
            <strong style="color: var(--text-gold);">RARE ROOT</strong> is a premium streetwear collective designed for the disciplined. 
            Rooted in Nigeria and serving the global hustle, we provide the high-performance uniform for those who move in silence. 
            Analyzing charts during a late-night trading session or pushing past your limits at the gym, our apparel represents your dedication to the grind.
        </p>
    </section>

    <div class="container">
        <!-- SEARCH BAR -->
        <div class="search-container"></div>

    <div class="collection-header">
        <h2 class="category-title">THE EXCHANGE</h2>
        <p class="category-subtitle">Calculated Moves. Legacy Built.</p>
    </div>
    <div class="grid" id="exchange-grid"></div>

    <div class="collection-header">
        <h2 class="category-title">KINETIC</h2>
        <p class="category-subtitle">Form Meets Function. The Street Performance Line.</p>
    </div>
    <div class="grid" id="kinetic-grid"></div>

    <div class="collection-header">
        <h2 class="category-title">URBAN ARCHIVE</h2>
        <p class="category-subtitle">The Signature Street Silhouettes.</p>
    </div>
    <div class="grid" id="urban-grid"></div>

    </div>

    <!-- Newsletter Section -->
    <div class="newsletter-section">
        <div class="newsletter-content">
            <h3>Join The Inner Circle</h3>
            <p>Exclusive drops, early access, and insider trading.</p>
            <form class="newsletter-form" onsubmit="event.preventDefault(); alert('Welcome to the inner circle.');">
                <input type="email" placeholder="Enter your email" required>
                <button type="submit">Subscribe</button>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-col brand-col">
                <img src="https://files.fm/thumb.php?i=y628qspy4s" alt="RARE ROOT" class="footer-logo">
                <p>Prestige in every thread.</p>
            </div>
            <div class="footer-col">
                <h4>Shop</h4>
                <a href="#exchange-grid">The Exchange</a>
                <a href="#kinetic-grid">Kinetic</a>
                <a href="#urban-grid">Urban Archive</a>
            </div>
            <div class="footer-col">
                <h4>Support</h4>
                <a href="#">Shipping & Returns</a>
                <a href="#">Size Guide</a>
                <a href="#">Contact Us</a>
                <a href="admin/index.html" style="opacity: 0.5; font-size: 0.8rem;">Admin Access</a>
            </div>
            <div class="footer-col">
                <h4>Stay Connected</h4>
                <div class="social-links">
                    <a href="#">Instagram</a>
                    <a href="#">Twitter</a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2026 RARE ROOT. All rights reserved.</p>
        </div>
    </footer>

    <div class="overlay" id="overlay" onclick="closeAllDrawers()"></div>

    <!-- Mobile Menu Drawer -->
    <div class="menu-drawer" id="menu-drawer">
        <div class="menu-header">
            <span class="menu-title">Menu</span>
            <button class="close-menu" onclick="toggleMenu()">×</button>
        </div>
        <ul class="menu-links">
            <li><a href="#" onclick="toggleMenu()">Home</a></li>
            <li><a href="#exchange-grid" onclick="toggleMenu()">The Exchange</a></li>
            <li><a href="#kinetic-grid" onclick="toggleMenu()">Kinetic</a></li>
            <li><a href="#urban-grid" onclick="toggleMenu()">Urban Archive</a></li>
            <li><a href="footer" onclick="toggleMenu()">Contact</a></li>
        </ul>
    </div>

    <div class="cart-drawer" id="cart-drawer">
        <div class="cart-header">
            <span class="cart-title">Your Bag</span>
            <button class="close-cart" onclick="toggleCart()">×</button>
        </div>
        <div class="cart-items" id="cart-items">
            <p style="text-align:center; color:#888; margin-top:20px;">Your bag is empty.</p>
        </div>
        <div class="cart-footer">
            <div class="total-price">
                <span>Total</span>
                <span id="cart-total">₦0</span>
            </div>
            <button class="btn-checkout" onclick="checkout()">Checkout Now</button>
        </div>
    </div>

    <div id="toast" class="toast">Notification</div>

    <!-- Product Details Modal -->
    <div id="product-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <div class="modal-body" id="modal-body">
                <!-- Content injected by JS -->
            </div>
        </div>
    </div>

    <!-- Script removed for GitHub Pages compatibility -->
    <script>
// ------------------------------------------------
// 1. DATABASE & STATE
// ------------------------------------------------
let products = [];
let cart = [];
let currentModalProduct = null;

// Fetch Products from JSON (Simulating Database)
async function fetchProducts() {
    try {
        // Determine Raw URL: Use Admin Config if available (for instant feedback), otherwise default
        let user = 'SMT-cmd';
        let repo = 'smt-cmd.github.io';
        
        // If user is admin, use their configured repo to ensure they see their own changes immediately
        const adminConfig = JSON.parse(localStorage.getItem('rare_root_admin') || 'null');
        if (adminConfig && adminConfig.user && adminConfig.repo) {
            user = adminConfig.user;
            repo = adminConfig.repo;
        }

        // 1. Try fetching from GitHub Raw first (Faster updates, bypasses Pages build cache)
        const rawUrl = `https://raw.githubusercontent.com/${user}/${repo}/main/data/products.json?t=` + new Date().getTime();
        let response = await fetch(rawUrl);
        
        // 2. Fallback to local/relative if Raw fails (e.g. running locally or repo name mismatch)
        if (!response.ok) {
            console.warn('Raw GitHub fetch failed, falling back to local file.');
            response = await fetch('data/products.json?t=' + new Date().getTime());
        }

        const data = await response.json();
        products = data.products || [];
        console.log('Loaded products:', products.length, products); // Debugging
        initializeShop();
    } catch (error) {
        console.error('Error loading products:', error);
        showToast('Error loading shop inventory.');
    }
}



function initializeShop() {
    // Render all categories
    const categories = [...new Set(products.map(p => p.category))];
    
    // Clear existing grids first (in case of re-init)
    document.querySelectorAll('.grid').forEach(grid => grid.innerHTML = '');

    // If we have specific grids in HTML, render to them
    renderCategory("The Exchange", "exchange-grid");
    renderCategory("Kinetic", "kinetic-grid");
    renderCategory("Urban Archive", "urban-grid");
    
    // Also render others if they exist in data but not explicitly in HTML structure
    // (Future proofing: dynamic category creation could go here)
}

// ------------------------------------------------
// 2. RENDERING
// ------------------------------------------------
function renderCategory(categoryName, elementId) {
    const container = document.getElementById(elementId);
    if (!container) return; 
    
    // Filter by category and ensure not hidden
    // Normalize string comparison to avoid case/space issues
    const items = products.filter(p => p.category.trim() === categoryName.trim() && !p.hidden);
    
    if (items.length === 0) {
        // Optional: Hide section if empty
        // container.previousElementSibling.style.display = 'none';
        container.innerHTML = '<p style="grid-column: 1/-1; text-align:center; opacity:0.5;">Coming Soon</p>';
        return;
    }

    container.innerHTML = ''; // Clear current content
    
    items.forEach(product => {
        const card = document.createElement('div');
        card.className = 'product-card';
        card.onclick = () => openProductModal(product.id);
        
        const isSale = product.sale_price && product.sale_price < product.price;
        const priceDisplay = isSale 
            ? `<span class="original-price">₦${product.price.toLocaleString()}</span> <span class="sale-price">₦${product.sale_price.toLocaleString()}</span>` 
            : `₦${product.price.toLocaleString()}`;
        
        const discountBadge = isSale 
            ? `<span class="discount-badge">-${Math.round(((product.price - product.sale_price) / product.price) * 100)}%</span>` 
            : '';

        card.innerHTML = `
            <div class="product-image-container">
                ${discountBadge}
                <img src="${product.img}" alt="${product.name}" loading="lazy">
                <button class="add-to-cart-btn">
                    Quick View
                </button>
            </div>
            <div class="product-info">
                <h3>${product.name}</h3>
                <p class="price">${priceDisplay}</p>
            </div>
        `;
        container.appendChild(card);
    });
}

// ------------------------------------------------
// 3. PRODUCT MODAL & SELECTION
// ------------------------------------------------
function openProductModal(id) {
    const product = products.find(p => p.id === id);
    if (!product) return;

    currentModalProduct = product;
    const modal = document.getElementById('product-modal');
    const modalBody = document.getElementById('modal-body');

    // Price Logic
    let priceDisplay = `₦${product.price.toLocaleString()}`;
    let actualPrice = product.price;
    if (product.sale_price) {
        priceDisplay = `<span class="old-price">₦${product.price.toLocaleString()}</span> ₦${product.sale_price.toLocaleString()}`;
        actualPrice = product.sale_price;
    }

    // Generate Size Options
    let sizeOptions = product.sizes ? product.sizes.map(s => `<option value="${s}">${s}</option>`).join('') : '<option>One Size</option>';
    
    // Generate Color/Variant Logic
    let variants = product.variants || [];
    
    // Fallback for legacy products
    if (variants.length === 0 && product.colors) {
        variants = product.colors.map(c => ({
            color: c.color,
            image: product.img // Use main image as fallback
        }));
    }
    // If still no variants, create a dummy one
    if (variants.length === 0) {
        variants = [{color: 'Standard', image: product.img}];
    }

    // Generate Options
    const colorOptions = variants.map(v => 
        `<option value="${v.color}" data-img="${v.image}">${v.color}</option>`
    ).join('');

    // Generate Thumbnails
    let thumbnailsHtml = '';
    if (variants.length > 1) {
        thumbnailsHtml = `<div class="modal-thumbnails" style="display:flex; gap:10px; margin-top:10px; overflow-x:auto; padding-bottom:5px;">
            ${variants.map(v => `
                <img src="${v.image}" 
                     alt="${v.color}" 
                     style="width:60px; height:60px; object-fit:cover; border:1px solid #555; cursor:pointer; flex-shrink:0;" 
                     onclick="updateModalImage('${v.image}', '${v.color}')"
                     class="thumb-img">
            `).join('')}
        </div>`;
    }

    // Initial Image (first variant or product main image)
    const initialImg = variants[0].image || product.img;

    modalBody.innerHTML = `
        <div class="modal-left">
            <img src="${initialImg}" alt="${product.name}" class="modal-img" id="modal-main-img">
            ${thumbnailsHtml}
        </div>
        <div class="modal-info">
            <h2>${product.name}</h2>
            <div class="modal-price">${priceDisplay}</div>
            <p style="opacity:0.8; margin-bottom:20px;">${product.description || "Premium quality fabric, designed for the driven."}</p>
            
            <div class="modal-opt-group">
                <label class="modal-opt-label">Size</label>
                <select id="modal-size" class="modal-select">
                    ${sizeOptions}
                </select>
            </div>
            
            <div class="modal-opt-group">
                <label class="modal-opt-label">Color</label>
                <select id="modal-color" class="modal-select" onchange="onColorChange(this)">
                    ${colorOptions}
                </select>
            </div>

            <button class="btn-checkout" onclick="addToCartFromModal()">Add to Bag - ₦${actualPrice.toLocaleString()}</button>
        </div>
    `;

    modal.style.display = "block";
}

function updateModalImage(src, color) {
    const img = document.getElementById('modal-main-img');
    if(img) img.src = src;
    
    // Also update the select dropdown if color is provided
    if (color) {
        const select = document.getElementById('modal-color');
        if (select) select.value = color;
    }
}

function onColorChange(select) {
    const selectedOption = select.options[select.selectedIndex];
    const imgSrc = selectedOption.getAttribute('data-img');
    if (imgSrc) {
        updateModalImage(imgSrc);
    }
}

function closeModal() {
    document.getElementById('product-modal').style.display = "none";
    currentModalProduct = null;
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('product-modal');
    if (event.target == modal) {
        closeModal();
    }
}

function addToCartFromModal() {
    if (!currentModalProduct) return;

    const size = document.getElementById('modal-size').value;
    const colorSelect = document.getElementById('modal-color');
    const color = colorSelect.value;
    const selectedOption = colorSelect.options[colorSelect.selectedIndex];
    const variantImg = selectedOption.getAttribute('data-img');

    const price = currentModalProduct.sale_price || currentModalProduct.price;

    const cartItem = {
        ...currentModalProduct,
        img: variantImg || currentModalProduct.img, // Use variant image
        selectedSize: size,
        selectedColor: color,
        finalPrice: price,
        cartId: Date.now() // Unique ID for cart entry
    };

    cart.push(cartItem);
    updateCartUI();
    closeModal();
    showToast(`Added ${currentModalProduct.name} (${size})`);
    toggleCart(); // Open cart to show item
}

// ------------------------------------------------
// 4. CART LOGIC
// ------------------------------------------------
function updateCartUI() {
    const cartItemsContainer = document.getElementById('cart-items');
    const cartCount = document.getElementById('cart-count');
    const cartTotal = document.getElementById('cart-total');

    // Update Count
    cartCount.innerText = cart.length;

    // Update Items
    cartItemsContainer.innerHTML = '';
    let total = 0;

    if (cart.length === 0) {
        cartItemsContainer.innerHTML = '<p style="text-align:center; color:#888; margin-top:20px;">Your bag is empty.</p>';
    } else {
        cart.forEach((item, index) => {
            total += item.finalPrice;
            const itemDiv = document.createElement('div');
            itemDiv.className = 'cart-item';
            itemDiv.innerHTML = `
                <div style="display:flex; align-items:center; gap:10px;">
                    <img src="${item.img}" style="width:50px; height:50px; object-fit:cover; border:1px solid #333;">
                    <div>
                        <div style="color:white; font-weight:bold; font-size:0.9rem;">${item.name}</div>
                        <div style="font-size:0.8rem; color:#888;">${item.selectedSize} | ${item.selectedColor}</div>
                    </div>
                </div>
                <div style="text-align:right;">
                    <div>₦${item.finalPrice.toLocaleString()}</div>
                    <div style="color:#aa4444; font-size:0.8rem; cursor:pointer; margin-top:5px;" onclick="removeFromCart(${item.cartId})">Remove</div>
                </div>
            `;
            cartItemsContainer.appendChild(itemDiv);
        });
    }

    // Update Total
    cartTotal.innerText = '₦' + total.toLocaleString();
}

function removeFromCart(cartId) {
    cart = cart.filter(item => item.cartId !== cartId);
    updateCartUI();
}

function toggleCart() {
    const drawer = document.getElementById('cart-drawer');
    const overlay = document.getElementById('overlay');
    
    if (drawer.classList.contains('open')) {
        drawer.classList.remove('open');
        overlay.classList.remove('active');
    } else {
        document.getElementById('menu-drawer').classList.remove('open');
        drawer.classList.add('open');
        overlay.classList.add('active');
    }
}

function toggleMenu() {
    const drawer = document.getElementById('menu-drawer');
    const overlay = document.getElementById('overlay');
    
    if (drawer.classList.contains('open')) {
        drawer.classList.remove('open');
        overlay.classList.remove('active');
    } else {
        document.getElementById('cart-drawer').classList.remove('open');
        drawer.classList.add('open');
        overlay.classList.add('active');
    }
}

function closeAllDrawers() {
    document.getElementById('menu-drawer').classList.remove('open');
    document.getElementById('cart-drawer').classList.remove('open');
    document.getElementById('overlay').classList.remove('active');
}

// ------------------------------------------------
// 5. SEARCH LOGIC
// ------------------------------------------------
function handleSearch(query) {
    const term = query.toLowerCase();
    
    if (!term) {
        // Reset to default view
        initializeShop();
        return;
    }

    // Find all matching products
    const matches = products.filter(p => 
        !p.hidden && (
            p.name.toLowerCase().includes(term) || 
            p.category.toLowerCase().includes(term) ||
             (p.tags && p.tags.some(tag => (typeof tag === 'string' ? tag : tag.tag || '').toLowerCase().includes(term))) ||
             (p.description && p.description.toLowerCase().includes(term))
         )
    );

    // Render Search Results (Hi-jack one grid or create a results view)
    // Strategy: Hide all grids, show results in the first one with a title change
    
    // Simplest approach: Filter the existing grids in place? 
    // No, because a search might return items from multiple categories.
    // Better: Clear all grids, and render matches into the first grid (The Exchange) and hide others titles.
    
    document.getElementById('exchange-grid').innerHTML = '';
    document.getElementById('kinetic-grid').innerHTML = '';
    document.getElementById('urban-grid').innerHTML = '';
    
    // Hide headers temporarily (optional, but cleaner)
    document.querySelectorAll('.collection-header').forEach(el => el.style.display = 'none');
    
    // Create a temporary results header if not exists
    let resultsHeader = document.getElementById('search-results-header');
    if (!resultsHeader) {
        resultsHeader = document.createElement('div');
        resultsHeader.id = 'search-results-header';
        resultsHeader.className = 'collection-header';
        resultsHeader.innerHTML = '<h2 class="category-title">Search Results</h2>';
        document.getElementById('exchange-grid').parentNode.insertBefore(resultsHeader, document.getElementById('exchange-grid'));
    }
    resultsHeader.style.display = 'block';

    if (matches.length === 0) {
        document.getElementById('exchange-grid').innerHTML = '<p style="text-align:center; padding:40px;">No products found.</p>';
    } else {
        const container = document.getElementById('exchange-grid');
        matches.forEach(product => {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.onclick = () => openProductModal(product.id);
            
            const isSale = product.sale_price && product.sale_price < product.price;
            const priceDisplay = isSale 
                ? `<span class="original-price">₦${product.price.toLocaleString()}</span> <span class="sale-price">₦${product.sale_price.toLocaleString()}</span>` 
                : `₦${product.price.toLocaleString()}`;
            
            const discountBadge = isSale 
                ? `<span class="discount-badge">-${Math.round(((product.price - product.sale_price) / product.price) * 100)}%</span>` 
                : '';

            card.innerHTML = `
                <div class="product-image-container">
                    ${discountBadge}
                    <img src="${product.img}" alt="${product.name}" loading="lazy">
                    <button class="add-to-cart-btn">
                        Quick View
                    </button>
                </div>
                <div class="product-info">
                    <h3>${product.name}</h3>
                    <p class="price">${priceDisplay}</p>
                </div>
            `;
            container.appendChild(card);
        });
    }
}

// Reset view helper (when search is cleared)
document.getElementById('search-input').addEventListener('input', (e) => {
    if (e.target.value === '') {
        document.querySelectorAll('.collection-header').forEach(el => el.style.display = 'block');
        const resultsHeader = document.getElementById('search-results-header');
        if (resultsHeader) resultsHeader.style.display = 'none';
        initializeShop();
    }
});


// ------------------------------------------------
// 6. UTILITIES (Toast, Checkout)
// ------------------------------------------------
function showToast(message) {
    const toast = document.getElementById("toast");
    if (!toast) return;
    toast.innerText = message;
    toast.className = "toast show";
    setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
}

function checkout() {
    if (cart.length === 0) {
        showToast("Your bag is empty.");
        return;
    }
    let totalAmount = cart.reduce((sum, item) => sum + item.finalPrice, 0);
    let email = prompt("Enter your email for the receipt:");
    if (email) {
        // Simulating Paystack for now
        alert(`Proceeding to payment of ₦${totalAmount.toLocaleString()} for ${email}`);
        // In real integration: PaystackPop.setup({...}).openIframe();
    }
}

// ------------------------------------------------
// INITIALIZATION
// ------------------------------------------------
document.addEventListener('DOMContentLoaded', () => {
    fetchProducts();
    
    // Initialize Netlify Identity if present
    // (Disabled for GitHub Pages compatibility)
    // if (window.netlifyIdentity) { ... }
});
    </script>
</body>
</html>
